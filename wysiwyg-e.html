<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../undo-mgr/behavior.html">
<link rel="import" href="../selection-mgr/behavior.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../prism-element/prism-import.html">
<dom-module id="wysiwyg-e">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				overflow-y: auto;
				font-family: Roboto;
			}

			#toolbar {
				height: auto;
				--paper-toolbar-content: {
					height: auto!important;
					padding: 0;
				};
				background: var(--wysiwyg-toolbar-background, #2A9AF2);
				user-select: none;
		    color: var(--wysiwyg-toolbar-color, white);
		    @apply(--wysiwyg-toolbar);
			}

			#editable {
				padding: 20px;
				outline: none;
				@apply(--wysiwyg-editable);
				@apply(--layout-flex);
			}

			#editable :first-child {
				margin-top: 0;
				@apply(--wysiwyg-editable-first-child);
			}

			#editable :last-child {
				margin-bottom: 0;
				@apply(--wysiwyg-editable-last-child);
			}

			#editable ::selection {
				color: white;
				background: #2A9AF2;
				@apply(--wysiwyg-editable-selection);
			}

			#editable ol {
			  padding-left: 30px;
			  @apply(--wysiwyg-editable-ol);
			}

			#editable ul {
				padding-left: 30px;
				@apply(--wysiwyg-editable-ul);
			}

			#editable li {
				@apply(--wysiwyg-editable-li);
			}

			#editable a {
				color: #2A9AF2;
				@apply(--wysiwyg-editable-a);
			}

      #editable img {
        @apply(--wysiwyg-editable-img);
      }

      #editable blockquote {
        padding: 15px;
        margin: 0;
        border-left: 5px solid #eee;
        @apply(--wysiwyg-editable-blockquote);
      }

      #editable code {
        display: block;
        padding: 16px;
        line-height: 1.5;
        background-color: #f7f7f7;
        border-radius: 3px;
        @apply(--wysiwyg-editable-pre);
      }

      #editable p {
        @apply(--wysiwyg-editable-p);
      }

      #editable h1 {
        @apply(--wysiwyg-editable-h1);
      }

      #editable h2{
        @apply(--wysiwyg-editable-h2);
      }

      #editable h3 {
        @apply(--wysiwyg-editable-h3);
      }

      #editable h4 {
        @apply(--wysiwyg-editable-h4);
      }

      #editable h5 {
        @apply(--wysiwyg-editable-h5);
      }

      #editable h6 {
        @apply(--wysiwyg-editable-h6);
      }

      #editable b {
        @apply(--wysiwyg-editable-b);
      }

      #editable u {
        @apply(--wysiwyg-editable-u);
      }

      #editable i {
        @apply(--wysiwyg-editable-i);
      }

      #editable strike {
        @apply(--wysiwyg-editable-strike);
      }

			#editable input[type=checkbox] {
        @apply(--wysiwyg-editable-checkbox);
      }

      #html {
        padding: 0 20px 20px 20px;
        @apply(--wysiwyg-html);
        @apply(--layout-flex);
      }

      #html pre {
        margin: 0;
        @apply(--wysiwyg-html-pre);
      }

      #html code {
        display: block;
        word-wrap: break-word;
        @apply(--wysiwyg-html-code);
      }

		  paper-button {
		    padding: 0;
		    margin: 0;
        height: 40px;
        line-height: 40px;
        border-radius: 0px;
        min-width: 40px;
        background: transparent;
        text-transform: none;
		  }

      paper-menu-button {
        padding: 0;
      }

      paper-item:hover {
        cursor: pointer;
      }

      :host([mode="read"]) ::content .wysiwyg-tool,
      :host([mode="html"]) ::content .wysiwyg-tool {
        visibility: hidden;
      }

      @media (min-width: 768px) {
        #layout {
          @apply(--layout-vertical);
        }

        #toolbarLayout {
          @apply(--layout-horizontal);
          @apply(--layout-wrap);
          @apply(--layout-center-justified);
        }
      }

      @media (max-width: 767px) {
        #layout {
          @apply(--layout-horizontal);
        }

        #toolbarLayout {
          @apply(--layout-vertical);
          width: 40px;
        }
      }

      #content {
        overflow-y: auto;
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
		</style>
		<div class="fit" id="layout">
			<paper-toolbar id="toolbar" on-tap="updateTools">
				<div id="toolbarLayout" on-undo="undo" on-redo="redo">
				  <paper-menu-button>
  				  <paper-button class="dropdown-trigger">
  				    <iron-icon icon="settings"></iron-icon>
  				  </paper-button>
				    <paper-listbox class="dropdown-content" selected="{{mode}}" attr-for-selected="mode">
				      <paper-item mode="edit">Edit</paper-item>
				      <paper-item mode="read">Read-only</paper-item>
				      <paper-item mode="html">View HTML</paper-item>
				    </paper-listbox>
				  </paper-menu-button>
					<content select=".wysiwyg-tool" id="tools"></content>
				</div>
			</paper-toolbar>
			<div id="content">
			  <div id="editable" contenteditable$="[[_edit(mode)]]" hidden$="[[_html(mode)]]"></div>
		    <div id="html" hidden$="[[!_html(mode)]]">
		      <pre>
		        <code inner-h-t-m-l="[[_prismHighlight(value)]]"></code>
		      </pre>
        </div>
			</div>
		</div>
	</template>
	<script>
		Polymer(
			{
				is: 'wysiwyg-e',
				behaviors: [
					UndoMgrBehavior,
					SelectionMgrBehavior
				],
				listeners: {
					'restore-selection': 'restoreSelection',
					'select-element': '_selectElement'
				},
				observers: [
					'updateTools(range0, selectedLink, selectedImage, canRedo, canUndo, value, commonAncestorPath)'
				],
				properties: {
				  mode: {
				    type: String,
				    value: 'edit',
				    observer: '_modeChanged',
				    reflectToAttribute: true
				  },
					target: {
						type: Object,
						value: function () {
							return this.$.editable;
						},
						observer: '_targetChanged'
					}
				},
				ready: function () {
					Polymer.dom(this.$.tools).observeNodes(
						function () {
							this.updateTools();
						}.bind(this)
					);

          //Link handler for read-only mode
          this.target.addEventListener(
            'click',
            function (event) {
              if (this.mode !== 'read') return false;

              this.async(
                function () {
                  if (this.selectedLink) window.open(this.selectedLink.href);
                },
                100
              );
            }.bind(this)
          );
				},
				disconnect: function () {
					UndoMgrBehavior.disconnect.apply(this, arguments);
					SelectionMgrBehavior.disconnect.apply(this, arguments);
				},
				observe: function () {
					UndoMgrBehavior.observe.apply(this, arguments);
					SelectionMgrBehavior.observe.apply(this, arguments);
				},
    		redo: function () {
    		  if (this.mode !== 'edit') return false;
    		  return UndoMgrBehavior.redo.apply(this, arguments);
    		},
    		sanitize: function (html) {
    		  html = UndoMgrBehavior.sanitize.apply(this, arguments);
    		  var div = document.createElement('div'), i;
    		  div.innerHTML = html;

          //Strip classes
          var classes = div.querySelectorAll('[class]');

          for (i = 0; i < classes.length; i += 1) {
            classes[i].removeAttribute('class');
            classes[i].classList.add('style-scope');
            classes[i].classList.add('wysiwyg-e');
          }

          //Replace strong with b
          var strong = div.querySelectorAll('strong');

          for (i = 0; i < strong.length; i += 1) {
            strong[i].outerHTML = '<b>' + strong[i].innerHTML + '</b>';
          }

          //Replace em with i
          var em = div.querySelectorAll('em');

          for (i = 0; i < em.length; i += 1) {
            em[i].outerHTML = '<i>' + em[i].innerHTML + '</i>';
          }

          //Replace div with p
          var divs = div.querySelectorAll('div');

          for (i = 0; i < divs.length; i += 1) {
            divs[i].outerHTML = '<p>' + divs[i].innerHTML + '</p>';
          }

    		  return div.innerHTML;
    		},
    		undo: function () {
    		  if (this.mode !== 'edit') return false;
    		  return UndoMgrBehavior.undo.apply(this, arguments);
    		},
				updateTools: function () {
					var tools = Polymer.dom(this.$.tools).getDistributedNodes();

					for (var i = 0; i < tools.length; i += 1) {
						tools[i]._setRange0(this.range0);
						tools[i]._setSelectedImage(this.selectedImage);
						tools[i]._setSelectedLink(this.selectedLink);
						tools[i]._setCanRedo(this.canRedo);
						tools[i]._setCanUndo(this.canUndo);
						tools[i]._setValue(this.value);
						tools[i]._setCommonAncestorPath(this.commonAncestorPath);
						tools[i]._setTarget(this.target);
					}
				},
				_edit: function (a, b) {
				  return this.mode === 'edit';
				},
				_html: function () {
				  return this.mode === 'html';
				},
				_modeChanged: function () {
				  if (['edit', 'read', 'html'].indexOf(this.mode) === -1) {
				    this.mode = 'edit';
				    return;
				  }
				},
				_panelMode: function () {
				  if (this.mode !== 'edit') return 'seamed';
				  return 'waterfall';
				},
				_prismHighlight: function (value) {
				  // process and format functions from
				  // http://stackoverflow.com/questions/26360414/javascript-how-to-correct-indentation-in-html-string

				  function process (str) {
            var div = document.createElement('div');
            div.innerHTML = str.trim();
            return format(div, 0).innerHTML;
          }

          function format (node, level) {
            var indentBefore = new Array(level++ + 1).join('  '), indentAfter  = new Array(level - 1).join('  '), textNode;

            for (var i = 0; i < node.children.length; i += 1) {
              textNode = document.createTextNode('\n' + indentBefore);
              node.insertBefore(textNode, node.children[i]);
              format(node.children[i], level);

              if (node.lastElementChild == node.children[i]) {
                textNode = document.createTextNode('\n' + indentAfter);
                node.appendChild(textNode);
              }
            }

            return node;
          }

					return Prism.highlight(process(value), Prism.languages.markup);
				},
				_selectElement: function (event) {
				  this.selectElement(event.detail.element);
				},
				_targetChanged: function () {
					UndoMgrBehavior._targetChanged.apply(this, arguments);
					SelectionMgrBehavior._targetChanged.apply(this, arguments);
				}
			}
		);
	</script>
</dom-module>
